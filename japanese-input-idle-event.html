<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Japanese input idle event</title>
</head>
<body>
<div>
<label>Input text with IME on:</label>
<input type="text" id="text1"></input>
<p>A log will be appended at 500ms after both of these conditions met.</p>
<ul>
<li>key inputs becomes idle.</li>
<li>IME does not have uncommitted text.</li>
</ul>
</div>
<div>
<div>
<label>log:</label>
</div>
<div>
<textarea rows="10" cols="40" id="log"></textarea>
</div>
<script src="js/jquery-1.11.0.js"></script>
<script>
$(function() {

  var oldText = undefined;
  var hasUncommittedTextInIME = false;
  var timer = undefined;
  function onFocusin(e) {
    oldText = $("#text1").val();
  }
  function resetTimer() {
    if (timer !== undefined) {
      clearTimeout(timer);
      timer = undefined;
    }
  }
  function onKeyup(e) {
    var text;

    resetTimer();

    // When enter key is pressed, IME commits text.
    if (e.which == 13) {
      hasUncommittedTextInIME = false;
    }

    // Set timer only when IME does not have uncommitted text.
    // Firefox fires events with e.which = 224 when IME has uncommitted text.
    if (!hasUncommittedTextInIME && e.which != 224) {
      var context = this;
      timer = setTimeout(function() {
        text = $("#text1").val();
        if (text != oldText) {
          oldText = text;
          doSomeWork.apply(context);
        }
      }, 500);
    }
  }
  function onKeydown(e) {
    // IE, Chrome and Safari fires events wich e.which = 229 when IME has
    // uncommitted text.
    if (e.which == 229) {
      hasUncommittedTextInIME = true;
    }
  }

  function doSomeWork() {
    log("Do some work with text: " + $("#text1").val());
  }

  function log(message) {
    var el = $("#log");
    el.text(el.text() + message + "\r");
    el.scrollTop(el[0].scrollHeight - el.height());
  }

  $("#text1").focusin(onFocusin).keydown(onKeydown).keyup(onKeyup);
});
</script>
</body>
</html>
